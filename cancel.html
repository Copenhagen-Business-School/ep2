<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betaling annulleret - CBS ePayment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .cbs-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .cbs-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; }
        .cbs-title { color: #212529; font-weight: 600; }
    </style>
</head>
<body>
    <div class="d-flex flex-column min-vh-100">
        <!-- Header -->
        <header class="cbs-header py-3">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold fs-4">CBS ePayment</span>
                    <div class="language-selector">
                        <button class="btn btn-link text-decoration-none" data-lang="da">DA</button>
                        <span class="text-muted">|</span>
                        <button class="btn btn-link text-decoration-none" data-lang="en">EN</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow-1 py-4">
            <div class="container">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="#6c757d" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                        </svg>
                    </div>
                    <h1 class="cbs-title mb-3" data-translate="paymentCancelled">Betaling annulleret</h1>
                    <p class="lead mb-4" data-translate="paymentCancelledDesc">Du har annulleret betalingen. Dit tilbud er stadig aktivt og du kan forsøge at betale igen.</p>

                    <!-- URL params from FarPay -->
                    <div class="card mx-auto" style="max-width: 600px;">
                        <div class="card-header">
                            <h5 class="mb-0" data-translate="urlParams">URL parametre fra FarPay</h5>
                        </div>
                        <div class="card-body text-start">
                            <dl class="row mb-0" id="params-list">
                                <!-- Populated by JavaScript -->
                            </dl>
                        </div>
                    </div>

                    <!-- Parsed info -->
                    <div class="card mx-auto mt-3" style="max-width: 600px;">
                        <div class="card-header">
                            <h5 class="mb-0" data-translate="parsedInfo">Parset information</h5>
                        </div>
                        <div class="card-body text-start">
                            <dl class="row mb-0">
                                <dt class="col-sm-5" data-translate="documentNo">Bilagsnummer</dt>
                                <dd class="col-sm-7 font-monospace" id="parsed-documentNo">-</dd>

                                <dt class="col-sm-5">Original TraceId</dt>
                                <dd class="col-sm-7 font-monospace" id="parsed-traceId">-</dd>

                                <dt class="col-sm-5">Timestamp</dt>
                                <dd class="col-sm-7 font-monospace" id="parsed-timestamp">-</dd>
                            </dl>
                        </div>
                    </div>

                    <div class="mt-4">
                        <p class="text-muted small">
                            <span data-translate="testNote">Dette er en test-side hostet på Azure Static Web App.</span>
                        </p>
                        <a href="/" class="btn btn-primary" data-translate="backToOverview">Tilbage til oversigt</a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="cbs-footer py-3 mt-auto">
            <div class="container text-center text-muted small">
                CBS ePayment Test - Azure Static Web App
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const translations = {
            da: {
                paymentCancelled: 'Betaling annulleret',
                paymentCancelledDesc: 'Du har annulleret betalingen. Dit tilbud er stadig aktivt og du kan forsøge at betale igen.',
                urlParams: 'URL parametre fra FarPay',
                parsedInfo: 'Parset information',
                documentNo: 'Bilagsnummer',
                backToOverview: 'Tilbage til oversigt',
                testNote: 'Dette er en test-side hostet på Azure Static Web App.'
            },
            en: {
                paymentCancelled: 'Payment cancelled',
                paymentCancelledDesc: 'You have cancelled the payment. Your offer is still active and you can try to pay again.',
                urlParams: 'URL parameters from FarPay',
                parsedInfo: 'Parsed information',
                documentNo: 'Document no.',
                backToOverview: 'Back to overview',
                testNote: 'This is a test page hosted on Azure Static Web App.'
            }
        };

        let currentLang = 'da';

        document.addEventListener('DOMContentLoaded', () => {
            setupLanguageSelector();
            displayUrlParams();
            parseExternalId();
        });

        function setupLanguageSelector() {
            const langButtons = document.querySelectorAll('[data-lang]');
            langButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentLang = btn.dataset.lang;
                    langButtons.forEach(b => b.classList.remove('active', 'fw-bold'));
                    btn.classList.add('active', 'fw-bold');
                    updateTranslations();
                });
            });
            document.querySelector('[data-lang="da"]').classList.add('active', 'fw-bold');
        }

        function updateTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (t[key]) el.textContent = t[key];
            });
        }

        function displayUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const list = document.getElementById('params-list');

            if (params.toString() === '') {
                list.innerHTML = '<p class="text-muted">Ingen URL parametre fundet</p>';
                return;
            }

            let html = '';
            for (const [key, value] of params) {
                html += `
                    <dt class="col-sm-4">${escapeHtml(key)}</dt>
                    <dd class="col-sm-8 font-monospace text-break">${escapeHtml(value)}</dd>
                `;
            }
            list.innerHTML = html;
        }

        function parseExternalId() {
            const params = new URLSearchParams(window.location.search);
            const externalId = params.get('externalId') || params.get('ExternalID') || params.get('externalid') || '';

            if (!externalId) {
                document.getElementById('parsed-documentNo').textContent = '-';
                document.getElementById('parsed-traceId').textContent = '-';
                document.getElementById('parsed-timestamp').textContent = '-';
                return;
            }

            // Parse: {DocumentNo}-{yyyyMMddHHmmss}-{traceId8chars}
            const parts = externalId.split('-');

            // Find timestamp (14 digits)
            let timestampIdx = -1;
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].length === 14 && /^\d+$/.test(parts[i])) {
                    timestampIdx = i;
                    break;
                }
            }

            if (timestampIdx > 0) {
                const documentNo = parts.slice(0, timestampIdx).join('-');
                const timestamp = parts[timestampIdx];
                const traceId = parts.length > timestampIdx + 1 ? parts[timestampIdx + 1] : '-';

                document.getElementById('parsed-documentNo').textContent = documentNo;
                document.getElementById('parsed-traceId').textContent = traceId;

                // Parse timestamp: yyyyMMddHHmmss
                if (timestamp.length === 14) {
                    const year = timestamp.slice(0, 4);
                    const month = timestamp.slice(4, 6);
                    const day = timestamp.slice(6, 8);
                    const hour = timestamp.slice(8, 10);
                    const min = timestamp.slice(10, 12);
                    const sec = timestamp.slice(12, 14);
                    document.getElementById('parsed-timestamp').textContent =
                        `${day}-${month}-${year} ${hour}:${min}:${sec}`;
                } else {
                    document.getElementById('parsed-timestamp').textContent = timestamp;
                }
            } else {
                document.getElementById('parsed-documentNo').textContent = externalId;
                document.getElementById('parsed-traceId').textContent = '-';
                document.getElementById('parsed-timestamp').textContent = '-';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
